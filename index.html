<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è½ä¸‰ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ </title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
min-height: 100vh;
background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
font-family: â€˜Courier Newâ€™, monospace;
position: relative;
overflow-x: hidden;
}

/* ã‚°ãƒªãƒƒãƒ‰èƒŒæ™¯ */
.grid-bg {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-image:
linear-gradient(rgba(0, 255, 136, 0.1) 1px, transparent 1px),
linear-gradient(90deg, rgba(0, 255, 136, 0.1) 1px, transparent 1px);
background-size: 50px 50px;
animation: gridMove 20s linear infinite;
pointer-events: none;
z-index: 0;
}

@keyframes gridMove {
0% { transform: translateY(0); }
100% { transform: translateY(50px); }
}

@keyframes glow {
0%, 100% { text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88, 0 0 30px #00ff88; }
50% { text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88; }
}

@keyframes pulse {
0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
50% { box-shadow: 0 0 30px rgba(0, 255, 136, 0.6); }
}

@keyframes slideIn {
from { transform: translateY(-20px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.container {
max-width: 800px;
width: 100%;
position: relative;
z-index: 1;
}

h1 {
text-align: center;
font-size: 28px;
color: #00ff88;
margin-bottom: 30px;
letter-spacing: 4px;
animation: glow 2s infinite;
text-transform: uppercase;
}

/* ç”»é¢å…±é€š */
.screen {
display: none;
animation: slideIn 0.5s ease-out;
}

.screen.active {
display: block;
}

/* ãƒœã‚¿ãƒ³ */
.btn {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
border: 3px solid #00ff88;
color: #fff;
padding: 15px 40px;
font-size: 16px;
font-family: â€˜Courier Newâ€™, monospace;
font-weight: bold;
cursor: pointer;
transition: all 0.3s;
box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
text-transform: uppercase;
letter-spacing: 2px;
}

.btn:hover {
transform: translateY(-3px);
box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
border-color: #ff0066;
}

.btn:active {
transform: translateY(0);
}

.btn-secondary {
background: rgba(0, 0, 0, 0.5);
border-color: #ff0066;
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
.game-input {
background: rgba(0, 0, 0, 0.6);
border: 3px solid #00ff88;
color: #00ff88;
padding: 18px;
font-size: 24px;
font-family: â€˜Courier Newâ€™, monospace;
width: 100%;
text-align: center;
outline: none;
animation: pulse 2s infinite;
letter-spacing: 2px;
}

.game-input:focus {
border-color: #ff0066;
box-shadow: 0 0 30px rgba(255, 0, 102, 0.5);
}

.game-input::placeholder {
color: rgba(0, 255, 136, 0.4);
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ */
.stat-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 12px;
margin-bottom: 25px;
}

.stat-card {
background: rgba(0, 0, 0, 0.6);
border: 2px solid #00ff88;
padding: 12px 8px;
text-align: center;
box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
}

.stat-label {
color: #00ff88;
font-size: 11px;
margin-bottom: 6px;
letter-spacing: 1px;
}

.stat-value {
color: #fff;
font-size: 22px;
font-weight: bold;
text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
}

.stat-value.warning { color: #ff0066; }
.stat-value.highlight { color: #ff0066; text-shadow: 0 0 10px #ff0066; }
.stat-value.good { color: #00ff88; }
.stat-value.mid { color: #ffaa00; }

/* å˜èªè¡¨ç¤ºã‚¨ãƒªã‚¢ */
.word-display {
background: rgba(0, 0, 0, 0.8);
border: 3px solid #00ff88;
padding: 35px 25px;
margin-bottom: 20px;
text-align: center;
box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
}

.kanji {
font-size: 52px;
color: #fff;
margin-bottom: 15px;
font-weight: bold;
letter-spacing: 6px;
text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
}

.hiragana {
font-size: 26px;
color: rgba(255, 255, 255, 0.7);
margin-bottom: 25px;
letter-spacing: 3px;
}

.romaji {
font-size: 30px;
letter-spacing: 5px;
padding-top: 20px;
border-top: 2px solid rgba(0, 255, 136, 0.3);
}

.char-pending { color: rgba(255, 255, 255, 0.3); }
.char-correct { color: #00ff88; text-shadow: 0 0 10px #00ff88; }
.char-wrong { color: #ff0066; text-shadow: 0 0 10px #ff0066; }

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ */
.loading-text {
text-align: center;
color: #00ff88;
font-size: 18px;
padding: 50px;
}

.error-box {
background: rgba(255, 0, 102, 0.1);
border: 2px solid #ff0066;
padding: 30px;
text-align: center;
box-shadow: 0 0 20px rgba(255, 0, 102, 0.3);
}

.error-msg {
color: #ff0066;
font-size: 16px;
margin-bottom: 15px;
}

.error-hint {
color: rgba(255, 255, 255, 0.6);
font-size: 13px;
margin-bottom: 20px;
}

/* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
.intro-text {
color: #fff;
font-size: 16px;
line-height: 2;
margin-bottom: 30px;
text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.word-count {
font-size: 13px;
color: rgba(255,255,255,0.5);
}

/* çµæœç”»é¢ */
.result-box {
background: rgba(0, 0, 0, 0.8);
border: 3px solid #ff0066;
padding: 35px;
margin-bottom: 25px;
box-shadow: 0 0 30px rgba(255, 0, 102, 0.5);
}

.result-title {
color: #ff0066;
font-size: 28px;
margin-bottom: 30px;
text-shadow: 0 0 15px #ff0066;
letter-spacing: 3px;
}

.result-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 20px;
margin-bottom: 30px;
}

.result-item {
text-align: center;
}

.result-label {
color: #00ff88;
font-size: 12px;
margin-bottom: 8px;
letter-spacing: 1px;
}

.result-value {
color: #fff;
font-size: 28px;
text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
}

.result-value.big {
font-size: 38px;
}

/* ã‚¹ã‚³ã‚¢ã‚³ãƒ¼ãƒ‰ */
.code-box {
background: rgba(0, 255, 136, 0.1);
border: 2px solid #00ff88;
padding: 25px;
margin-top: 25px;
text-align: center;
}

.code-label {
color: #00ff88;
font-size: 13px;
margin-bottom: 12px;
}

.code-value {
background: rgba(0, 0, 0, 0.6);
border: 1px solid rgba(0, 255, 136, 0.3);
color: #fff;
font-size: 42px;
font-weight: bold;
letter-spacing: 10px;
padding: 18px;
margin-bottom: 15px;
text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
}

.copy-btn {
background: rgba(0, 255, 136, 0.2);
border: 2px solid #00ff88;
color: #00ff88;
padding: 10px 25px;
font-size: 13px;
font-family: â€˜Courier Newâ€™, monospace;
cursor: pointer;
transition: all 0.3s;
letter-spacing: 1px;
}

.copy-btn:hover {
background: rgba(0, 255, 136, 0.4);
}

.code-hint {
color: rgba(255, 255, 255, 0.5);
font-size: 12px;
margin-top: 12px;
}

.result-msg {
background: rgba(0, 255, 136, 0.1);
border: 1px solid rgba(0, 255, 136, 0.3);
padding: 15px;
margin-top: 20px;
font-size: 16px;
color: #fff;
}

.center { text-align: center; }

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 600px) {
h1 { font-size: 22px; }
.stat-grid { grid-template-columns: repeat(2, 1fr); }
.result-grid { grid-template-columns: 1fr; }
.kanji { font-size: 40px; }
.romaji { font-size: 24px; }
.code-value { font-size: 32px; letter-spacing: 6px; }
}
</style>

</head>
<body>

<div class="grid-bg"></div>

<div class="container">
  <h1>è½ä¸‰ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->

  <div id="loading" class="screen active">
    <div class="loading-text">å˜èªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->

  <div id="error" class="screen">
    <div class="error-box">
      <div class="error-msg" id="errorMsg">ã‚¨ãƒ©ãƒ¼</div>
      <div class="error-hint">åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« words.csv ã‚’é…ç½®ã—ã¦ãã ã•ã„</div>
      <button class="btn btn-secondary" onclick="useBuiltinWords()">å†…è”µå˜èªã§ãƒ—ãƒ¬ã‚¤</button>
    </div>
  </div>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->

  <div id="start" class="screen">
    <div class="center">
      <p class="intro-text">
        60ç§’ä»¥å†…ã«ã§ãã‚‹ã ã‘å¤šãã®<br>
        æ—¥æœ¬èªã‚’ãƒ­ãƒ¼ãƒå­—ã§ã‚¿ã‚¤ãƒ—ã—ã‚ˆã†ï¼<br>
        <span class="word-count">ï¼ˆç™»éŒ²å˜èªæ•°: <span id="wordCount">0</span>èªï¼‰</span>
      </p>
      <button class="btn" onclick="startGame()">START GAME</button>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->

  <div id="game" class="screen">
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">TIME</div>
        <div class="stat-value" id="time">60</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">SCORE</div>
        <div class="stat-value" id="score">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">COMBO</div>
        <div class="stat-value" id="combo">0x</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ACCURACY</div>
        <div class="stat-value" id="accuracy">100%</div>
      </div>
    </div>

```
<div class="word-display">
  <div class="kanji" id="kanji">æº–å‚™ä¸­</div>
  <div class="hiragana" id="hiragana">-</div>
  <div class="romaji" id="romaji">-</div>
</div>

<input type="text" id="input" class="game-input" placeholder="TYPE HERE..." autocomplete="off">
```

  </div>

  <!-- çµæœç”»é¢ -->

  <div id="result" class="screen">
    <div class="result-box">
      <h2 class="result-title center">GAME OVER</h2>

```
  <div class="result-grid">
    <div class="result-item">
      <div class="result-label">FINAL SCORE</div>
      <div class="result-value big" id="finalScore">0</div>
    </div>
    <div class="result-item">
      <div class="result-label">ACCURACY</div>
      <div class="result-value" id="finalAccuracy">100%</div>
    </div>
    <div class="result-item">
      <div class="result-label">MAX COMBO</div>
      <div class="result-value" id="finalCombo">0x</div>
    </div>
  </div>
  
  <div class="code-box">
    <div class="code-label">ã‚¹ã‚³ã‚¢ç”³å‘Šã‚³ãƒ¼ãƒ‰ï¼ˆ5æ¡ï¼‰</div>
    <div class="code-value" id="scoreCode">00000</div>
    <button class="copy-btn" onclick="copyCode()">ã‚³ãƒ”ãƒ¼</button>
    <div class="code-hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å…ˆç”Ÿã«å ±å‘Šã—ã¦ãã ã•ã„</div>
  </div>
  
  <div class="result-msg" id="resultMsg"></div>
</div>

<div class="center">
  <button class="btn" onclick="restartGame()">PLAY AGAIN</button>
</div>
```

  </div>
</div>

<script>
// ãƒ­ãƒ¼ãƒå­—å¤‰æ›ãƒãƒƒãƒ”ãƒ³ã‚°
var romajiMap = {
  'ã‚': ['a'], 'ã„': ['i', 'yi'], 'ã†': ['u', 'wu', 'whu'], 'ãˆ': ['e'], 'ãŠ': ['o'],
  'ã‹': ['ka', 'ca'], 'ã': ['ki'], 'ã': ['ku', 'cu', 'qu'], 'ã‘': ['ke'], 'ã“': ['ko', 'co'],
  'ãŒ': ['ga'], 'ã': ['gi'], 'ã': ['gu'], 'ã’': ['ge'], 'ã”': ['go'],
  'ã•': ['sa'], 'ã—': ['si', 'shi', 'ci'], 'ã™': ['su'], 'ã›': ['se', 'ce'], 'ã': ['so'],
  'ã–': ['za'], 'ã˜': ['zi', 'ji'], 'ãš': ['zu'], 'ãœ': ['ze'], 'ã': ['zo'],
  'ãŸ': ['ta'], 'ã¡': ['ti', 'chi'], 'ã¤': ['tu', 'tsu'], 'ã¦': ['te'], 'ã¨': ['to'],
  'ã ': ['da'], 'ã¢': ['di'], 'ã¥': ['du', 'dzu'], 'ã§': ['de'], 'ã©': ['do'],
  'ãª': ['na'], 'ã«': ['ni'], 'ã¬': ['nu'], 'ã­': ['ne'], 'ã®': ['no'],
  'ã¯': ['ha'], 'ã²': ['hi'], 'ãµ': ['hu', 'fu'], 'ã¸': ['he'], 'ã»': ['ho'],
  'ã°': ['ba'], 'ã³': ['bi'], 'ã¶': ['bu'], 'ã¹': ['be'], 'ã¼': ['bo'],
  'ã±': ['pa'], 'ã´': ['pi'], 'ã·': ['pu'], 'ãº': ['pe'], 'ã½': ['po'],
  'ã¾': ['ma'], 'ã¿': ['mi'], 'ã‚€': ['mu'], 'ã‚': ['me'], 'ã‚‚': ['mo'],
  'ã‚„': ['ya'], 'ã‚†': ['yu'], 'ã‚ˆ': ['yo'],
  'ã‚‰': ['ra'], 'ã‚Š': ['ri'], 'ã‚‹': ['ru'], 'ã‚Œ': ['re'], 'ã‚': ['ro'],
  'ã‚': ['wa'], 'ã‚’': ['wo'], 'ã‚“': ['nn', 'n'],
  'ã': ['xa', 'la'], 'ãƒ': ['xi', 'li'], 'ã…': ['xu', 'lu'], 'ã‡': ['xe', 'le'], 'ã‰': ['xo', 'lo'],
  'ã‚ƒ': ['xya', 'lya'], 'ã‚…': ['xyu', 'lyu'], 'ã‚‡': ['xyo', 'lyo'],
  'ã£': ['xtu', 'ltu'],
  'ãã‚ƒ': ['kya'], 'ãã‚…': ['kyu'], 'ãã‚‡': ['kyo'],
  'ãã‚ƒ': ['gya'], 'ãã‚…': ['gyu'], 'ãã‚‡': ['gyo'],
  'ã—ã‚ƒ': ['sya', 'sha'], 'ã—ã‚…': ['syu', 'shu'], 'ã—ã‚‡': ['syo', 'sho'],
  'ã˜ã‚ƒ': ['ja', 'zya', 'jya'], 'ã˜ã‚…': ['ju', 'zyu', 'jyu'], 'ã˜ã‚‡': ['jo', 'zyo', 'jyo'],
  'ã¡ã‚ƒ': ['tya', 'cha', 'cya'], 'ã¡ã‚…': ['tyu', 'chu', 'cyu'], 'ã¡ã‚‡': ['tyo', 'cho', 'cyo'],
  'ã¢ã‚ƒ': ['dya'], 'ã¢ã‚…': ['dyu'], 'ã¢ã‚‡': ['dyo'],
  'ã«ã‚ƒ': ['nya'], 'ã«ã‚…': ['nyu'], 'ã«ã‚‡': ['nyo'],
  'ã²ã‚ƒ': ['hya'], 'ã²ã‚…': ['hyu'], 'ã²ã‚‡': ['hyo'],
  'ã³ã‚ƒ': ['bya'], 'ã³ã‚…': ['byu'], 'ã³ã‚‡': ['byo'],
  'ã´ã‚ƒ': ['pya'], 'ã´ã‚…': ['pyu'], 'ã´ã‚‡': ['pyo'],
  'ã¿ã‚ƒ': ['mya'], 'ã¿ã‚…': ['myu'], 'ã¿ã‚‡': ['myo'],
  'ã‚Šã‚ƒ': ['rya'], 'ã‚Šã‚…': ['ryu'], 'ã‚Šã‚‡': ['ryo']
};

// å†…è”µå˜èª
var builtinWords = [
  {kanji: 'æ—¥æœ¬', hiragana: 'ã«ã»ã‚“'},
  {kanji: 'å­¦æ ¡', hiragana: 'ãŒã£ã“ã†'},
  {kanji: 'å…ˆç”Ÿ', hiragana: 'ã›ã‚“ã›ã„'},
  {kanji: 'å‹‰å¼·', hiragana: 'ã¹ã‚“ãã‚‡ã†'},
  {kanji: 'å‹é”', hiragana: 'ã¨ã‚‚ã ã¡'},
  {kanji: 'é›»è©±', hiragana: 'ã§ã‚“ã‚'},
  {kanji: 'éŸ³æ¥½', hiragana: 'ãŠã‚“ãŒã'},
  {kanji: 'å¤©æ°—', hiragana: 'ã¦ã‚“ã'},
  {kanji: 'æ™‚é–“', hiragana: 'ã˜ã‹ã‚“'},
  {kanji: 'é£Ÿäº‹', hiragana: 'ã—ã‚‡ãã˜'},
  {kanji: 'æ˜ ç”»', hiragana: 'ãˆã„ãŒ'},
  {kanji: 'æ—…è¡Œ', hiragana: 'ã‚Šã‚‡ã“ã†'},
  {kanji: 'å†™çœŸ', hiragana: 'ã—ã‚ƒã—ã‚“'},
  {kanji: 'ç—…é™¢', hiragana: 'ã³ã‚‡ã†ã„ã‚“'},
  {kanji: 'ä¼šç¤¾', hiragana: 'ã‹ã„ã—ã‚ƒ'}
];

// ã‚²ãƒ¼ãƒ çŠ¶æ…‹
var words = [];
var currentWord = null;
var acceptableRomajis = [];
var displayRomaji = '';
var score = 0;
var combo = 0;
var maxCombo = 0;
var timeLeft = 60;
var timer = null;
var playing = false;
var totalTyped = 0;
var correctTyped = 0;
var encodedScore = '';

// ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
function showScreen(id) {
  var screens = document.querySelectorAll('.screen');
  for (var i = 0; i < screens.length; i++) {
    screens[i].classList.remove('active');
  }
  document.getElementById(id).classList.add('active');
}

// ã‚¹ã‚³ã‚¢ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
function encodeScore(s) {
  var scoreStr = ('0000' + s).slice(-4);
  var digits = [];
  for (var i = 0; i < scoreStr.length; i++) {
    digits.push(parseInt(scoreStr[i], 10));
  }
  var checksum = 0;
  for (var i = 0; i < digits.length; i++) {
    checksum += digits[i];
  }
  checksum = checksum % 10;
  var offsets = [7, 5, 3, 9];
  var encoded = [];
  for (var i = 0; i < digits.length; i++) {
    encoded.push((digits[i] + offsets[i]) % 10);
  }
  encoded.push(checksum);
  return encoded.join('');
}

// ã‚³ãƒ”ãƒ¼
function copyCode() {
  var code = encodedScore;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(function() {
      alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + code);
    }).catch(function() {
      fallbackCopy(code);
    });
  } else {
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  var textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-9999px';
  document.body.appendChild(textArea);
  textArea.select();
  try {
    document.execCommand('copy');
    alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + text);
  } catch (e) {
    alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰: ' + text);
  }
  document.body.removeChild(textArea);
}

// CSVèª­ã¿è¾¼ã¿
function loadCSV() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', './words.csv', true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200 || xhr.status === 0) {
        parseCSV(xhr.responseText);
      } else {
        showError('words.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }
  };
  xhr.onerror = function() {
    showError('words.csv ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  };
  try {
    xhr.send();
  } catch (e) {
    showError('words.csv ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“');
  }
}

function parseCSV(text) {
  var lines = text.trim().split('\n');
  words = [];
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) continue;
    if (i === 0 && line.charCodeAt(0) === 0xFEFF) {
      line = line.substring(1);
    }
    var parts = line.split(',');
    if (parts.length >= 2) {
      var kanji = parts[0].trim();
      var hiragana = parts[1].trim();
      if (kanji && hiragana) {
        words.push({ kanji: kanji, hiragana: hiragana });
      }
    }
  }
  
  if (words.length === 0) {
    showError('words.csv ã«æœ‰åŠ¹ãªå˜èªãŒã‚ã‚Šã¾ã›ã‚“');
  } else {
    document.getElementById('wordCount').textContent = words.length;
    showScreen('start');
  }
}

function showError(msg) {
  document.getElementById('errorMsg').textContent = msg;
  showScreen('error');
}

function useBuiltinWords() {
  words = builtinWords;
  document.getElementById('wordCount').textContent = words.length;
  showScreen('start');
}

// ãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆ
function generateRomajiPatterns(hiragana) {
  var results = [''];
  var i = 0;
  
  while (i < hiragana.length) {
    // ä¿ƒéŸ³å‡¦ç†
    if (hiragana[i] === 'ã£' && i + 1 < hiragana.length) {
      var nextTwo = hiragana.substring(i + 1, i + 3);
      var nextOne = hiragana[i + 1];
      var nextRomajis = romajiMap[nextTwo] || romajiMap[nextOne];
      
      if (nextRomajis) {
        var consonant = nextRomajis[0].charAt(0);
        var newResults = [];
        for (var r = 0; r < results.length; r++) {
          newResults.push(results[r] + consonant);
          newResults.push(results[r] + 'xtu');
          newResults.push(results[r] + 'ltu');
        }
        results = newResults;
        i++;
        continue;
      }
    }
    
    // 2æ–‡å­—
    if (i + 1 < hiragana.length) {
      var two = hiragana.substring(i, i + 2);
      if (romajiMap[two]) {
        var romajis = romajiMap[two];
        var newResults = [];
        for (var r = 0; r < results.length; r++) {
          for (var j = 0; j < romajis.length; j++) {
            newResults.push(results[r] + romajis[j]);
          }
        }
        results = newResults;
        i += 2;
        continue;
      }
    }
    
    // 1æ–‡å­—
    var one = hiragana[i];
    if (romajiMap[one]) {
      var romajis = romajiMap[one];
      var newResults = [];
      for (var r = 0; r < results.length; r++) {
        for (var j = 0; j < romajis.length; j++) {
          newResults.push(results[r] + romajis[j]);
        }
      }
      results = newResults;
    }
    i++;
  }
  
  return results;
}

// æ–°ã—ã„å˜èª
function setNewWord() {
  var idx = Math.floor(Math.random() * words.length);
  currentWord = words[idx];
  acceptableRomajis = generateRomajiPatterns(currentWord.hiragana);
  displayRomaji = acceptableRomajis[0];
  
  document.getElementById('kanji').textContent = currentWord.kanji;
  document.getElementById('hiragana').textContent = currentWord.hiragana;
  updateRomajiDisplay('');
}

function updateRomajiDisplay(typed) {
  var html = '';
  for (var i = 0; i < displayRomaji.length; i++) {
    if (i < typed.length) {
      html += '<span class="char-correct">' + displayRomaji[i] + '</span>';
    } else {
      html += '<span class="char-pending">' + displayRomaji[i] + '</span>';
    }
  }
  document.getElementById('romaji').innerHTML = html;
}

function updateStats() {
  document.getElementById('score').textContent = score;
  document.getElementById('combo').textContent = combo + 'x';
  
  var comboEl = document.getElementById('combo');
  comboEl.className = 'stat-value' + (combo > 0 ? ' highlight' : '');
  
  var acc = totalTyped > 0 ? Math.round((correctTyped / totalTyped) * 100) : 100;
  var accEl = document.getElementById('accuracy');
  accEl.textContent = acc + '%';
  if (acc >= 90) {
    accEl.className = 'stat-value good';
  } else if (acc >= 70) {
    accEl.className = 'stat-value mid';
  } else {
    accEl.className = 'stat-value warning';
  }
}

// å…¥åŠ›ãƒã‚§ãƒƒã‚¯
function checkInput() {
  var inputEl = document.getElementById('input');
  var value = inputEl.value.toLowerCase();
  
  // å®Œå…¨ä¸€è‡´
  for (var i = 0; i < acceptableRomajis.length; i++) {
    if (value === acceptableRomajis[i]) {
      score += 10 + combo;
      combo++;
      if (combo > maxCombo) maxCombo = combo;
      totalTyped += value.length;
      correctTyped += value.length;
      
      inputEl.value = '';
      setNewWord();
      updateStats();
      return;
    }
  }
  
  // éƒ¨åˆ†ä¸€è‡´
  var anyMatch = false;
  for (var i = 0; i < acceptableRomajis.length; i++) {
    if (acceptableRomajis[i].indexOf(value) === 0) {
      anyMatch = true;
      displayRomaji = acceptableRomajis[i];
      break;
    }
  }
  
  if (anyMatch) {
    totalTyped++;
    correctTyped++;
    updateRomajiDisplay(value);
  } else if (value.length > 0) {
    combo = 0;
    totalTyped++;
    inputEl.value = value.substring(0, value.length - 1);
  }
  updateStats();
}

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame() {
  playing = true;
  score = 0;
  combo = 0;
  maxCombo = 0;
  timeLeft = 60;
  totalTyped = 0;
  correctTyped = 0;
  
  updateStats();
  document.getElementById('time').textContent = timeLeft;
  document.getElementById('time').className = 'stat-value';
  
  showScreen('game');
  
  var inputEl = document.getElementById('input');
  inputEl.value = '';
  inputEl.focus();
  
  setNewWord();
  
  timer = setInterval(function() {
    timeLeft--;
    var timeEl = document.getElementById('time');
    timeEl.textContent = timeLeft;
    timeEl.className = 'stat-value' + (timeLeft <= 10 ? ' warning' : '');
    
    if (timeLeft <= 0) {
      endGame();
    }
  }, 1000);
}

// ã‚²ãƒ¼ãƒ çµ‚äº†
function endGame() {
  playing = false;
  clearInterval(timer);
  
  encodedScore = encodeScore(score);
  var acc = totalTyped > 0 ? Math.round((correctTyped / totalTyped) * 100) : 100;
  
  document.getElementById('finalScore').textContent = score;
  document.getElementById('finalAccuracy').textContent = acc + '%';
  document.getElementById('finalCombo').textContent = maxCombo + 'x';
  document.getElementById('scoreCode').textContent = encodedScore;
  
  var msg = '';
  if (acc >= 95) msg = 'ğŸ† ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ç´ æ™´ã‚‰ã—ã„ï¼';
  else if (acc >= 85) msg = 'â­ ã¨ã¦ã‚‚è‰¯ãã§ãã¾ã—ãŸï¼';
  else if (acc >= 70) msg = 'ğŸ‘ ã‚ˆãã§ãã¾ã—ãŸï¼';
  else msg = 'ğŸ’ª ã‚‚ã£ã¨ç·´ç¿’ã—ã‚ˆã†ï¼';
  document.getElementById('resultMsg').textContent = msg;
  
  showScreen('result');
}

function restartGame() {
  showScreen('start');
}

// ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('input').oninput = function() {
  if (playing) checkInput();
};

// åˆæœŸåŒ–
loadCSV();
</script>

</body>
</html>